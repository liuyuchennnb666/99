<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Camera OCR with History</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      text-align: center;
    }
    h1 {
      margin-top: 20px;
    }
    #camera-container {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background-color: black;
      overflow: hidden;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      z-index: 9999;
    }
    #camera {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    #status {
      position: fixed;
      bottom: 120px;
      right: 20px;
      width: 300px;
      font-size: 16px;
      font-weight: bold;
      background: #fff;
      padding: 10px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      display: none;
      word-wrap: break-word;
    }
    canvas {
      display: none;
    }
    pre {
      margin-top: 20px;
      padding: 10px;
      background-color: white;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      width: 90%;
      max-width: 600px;
      overflow-x: auto;
      text-align: left;
    }
    .button-container {
      margin-top: 20px;
    }
    button {
      padding: 10px;
      font-size: 16px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    button#start {
      background-color: green;
      color: white;
    }
    button#stop {
      background-color: red;
      color: white;
    }
    #history {
      margin-top: 20px;
    }
  </style>
</head>
<body>

<h1>实时OCR + AI 解答题目</h1>
<div id="camera-container">
  <video id="camera" autoplay playsinline></video>
</div>
<canvas id="canvas"></canvas>
<div id="status">AI 正在处理...</div>
<div class="button-container">
  <button id="start">启动摄像头</button>
  <button id="stop">停止摄像头</button>
</div>
<pre id="output">输出结果将在这里显示...</pre>
<div id="history">
  <h2>AI 历史解答</h2>
  <ul id="history-list"></ul>
</div>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js"></script>
<script>
  const video = document.getElementById('camera');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');
  const statusDiv = document.getElementById('status');
  const outputDiv = document.getElementById('output');
  const historyList = document.getElementById('history-list');
  const startButton = document.getElementById('start');
  const stopButton = document.getElementById('stop');

  let cameraOn = false;
  let captureInterval;
  let ocrResults = []; // 存储 OCR 捕获的所有文字结果
  const API_BASE_URL = 'https://api.chatanywhere.tech/v1'; // ChatAnywhere API 地址
  const API_KEY = 'sk-IuArZBKBkh1QgylKkPbuVdTmlAS9ynYRA8MyrbK6Rqi2tACZ'; // 替换为你的 API Key

  // **初始化摄像头**
  async function initCamera() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      video.srcObject = stream;
      console.log('Camera started successfully!');
    } catch (error) {
      console.error('Failed to access the camera:', error);
      alert('摄像头初始化失败，请检查设备和权限设置。');
    }
  }

  // **捕捉视频帧**
  async function captureFrame() {
    if (!video.videoWidth || !video.videoHeight) return;

    // 绘制视频帧到 Canvas
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

    const imageData = canvas.toDataURL('image/png');

    // OCR 识别
    try {
      const ocrResult = await Tesseract.recognize(imageData, 'chi_sim'); // 识别中文
      const text = ocrResult.data.text.trim();
      console.log('OCR Result:', text);
      if (text) {
        ocrResults.push(text); // 保存 OCR 结果
      }
    } catch (error) {
      console.error('OCR 处理失败:', error);
    }
  }

  // **发送文字到 GPT-4 处理**
  async function sendToGPT(fullText) {
    try {
      const response = await fetch(`${API_BASE_URL}/chat/completions`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${API_KEY}`
        },
        body: JSON.stringify({
          model: 'gpt-4',
          temperature: 0.2, // 降低随机性，确保输出更严格
          messages: [
            {
              role: 'system',
              content: `你是一个中文智能助手，需要将用户提供的 OCR 文本整理成合理的顺序，并根据文本解答问题。请严格按照以下要求：
              1. 对输入的文本进行逻辑性分析，拼接为完整的题目内容。
              2. 返回的内容必须包括拼接后的完整题目和答案。
              3. 答案必须以清晰的格式标明，且只包括合理的答案。
              示例输出格式：
              题目：
              [整理后的题目文本]
              
              答案：
              [合理的答案]`
            },
            {
              role: 'user',
              content: `以下是OCR捕获的完整文字：\n${fullText}\n请将文字整理为合理的顺序并解答题目。`
            }
          ]
        })
      });

      if (!response.ok) {
        throw new Error(`Error: ${response.status} ${response.statusText}`);
      }

      const result = await response.json();
      const gptAnswer = result.choices[0].message.content.trim();
      console.log('GPT-4 Result:', gptAnswer);

      // 显示结果并保存到历史记录
      outputDiv.textContent = `GPT-4 解答:\n${gptAnswer}`;
      addToHistory(fullText, gptAnswer);
      statusDiv.textContent = 'AI 处理完成！';
    } catch (error) {
      console.error('GPT-4 处理失败:', error);
      statusDiv.textContent = `GPT-4 处理失败: ${error.message}`;
    }
  }

  // **将解答添加到历史记录**
  function addToHistory(input, answer) {
    const listItem = document.createElement('li');
    listItem.textContent = `输入：${input} | 解答：${answer}`;
    historyList.appendChild(listItem);
  }

  // **启动摄像头**
  startButton.addEventListener('click', () => {
    if (cameraOn) return;
    cameraOn = true;
    initCamera();
    ocrResults = []; // 清空之前的 OCR 结果
    captureInterval = setInterval(captureFrame, 1000); // 每秒捕捉一次画面
    outputDiv.textContent = 'AI 处理已启动...';
  });

  // **停止摄像头并处理结果**
  stopButton.addEventListener('click', () => {
    if (!cameraOn) return;
    cameraOn = false;
    clearInterval(captureInterval);
    const stream = video.srcObject;
    if (stream) {
      const tracks = stream.getTracks();
      tracks.forEach(track => track.stop());
    }
    video.srcObject = null;

    // 拼接 OCR 结果并发送到 GPT-4
    const fullText = ocrResults.join('\n'); // 将所有捕获的文字拼接成完整文本
    console.log('Full OCR Text:', fullText);
    outputDiv.textContent = 'AI 正在处理捕获的文字，请稍候...';
    statusDiv.style.display = 'block';
    statusDiv.textContent = 'AI 正在拼接文字并解答...';
    sendToGPT(fullText);
  });
</script>
</body>
</html>